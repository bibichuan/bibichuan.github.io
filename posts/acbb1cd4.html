<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>技术研究之正射影像</title>
    <!-- 页面描述 -->
<meta name="description" content=""/>
<!-- 页面关键词 -->
<meta name="keywords" content=""/>
<!-- 网页作者 -->
<meta name="author" content="bibichuan, ibibichuan@gmail.com"/>
<!-- 搜索引擎抓取 -->
<meta name="robots" content="index,follow"/>

<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no"/>

<!--禁止百度转码-->
<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<!--启用WebApp全屏模式-->
<meta name="apple-mobile-web-app-capable" content="yes" />
<!--禁止数字自动识别为电话号码-->
<meta name="format-detection" content="telephone=no" />
<!--忽略识别邮箱-->
<meta name="format-detection" content="email=no" />
<!--360强制谷歌内核-->
<meta name="renderer" content="webkit"> 

<link rel="icon" href="/images/favicon.ico">

<link rel="stylesheet" href="//at.alicdn.com/t/font_1022896_nclaqhxyt.css">

<link href="/css/main.css" rel="stylesheet" type="text/css" />

<!-- 谷歌广告 -->
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8382618401389723"></script>


<script type="text/javascript" id="hexo.configurations">
  var BTheme = window.BTheme ||{};
  var CONFIG = {
    root: '/'
  };
</script>

<!--百度统计-->
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?ee4ff785c4c68fa9a0ea17241e0574ea";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>

<!--谷歌统计-->

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-G4HPTST8XX"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-G4HPTST8XX');
</script>

    
    
        
    
        
            
            
            <link href="/lib/layui/css/layui.css" rel="stylesheet" type="text/css" />
        
    

    
        
    

    
        
    


    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.6/dist/jquery.fancybox.min.css" />
<link rel="stylesheet" type="text/css" href="/lib/share/style/css/ishare.css">

<meta name="generator" content="Hexo 5.4.2"></head>
<body class="main">

    <header id="header" class="header layui-fluid">
        <div class="header-inner layui-row"><div class="header-wrap">
    <div class="logo_wrap">
        <a href="/"><img src="/images/logo.png"></a>
    </div>
    <div class='search-warp'>
  <div class="search">
    <input class="search-ipt" placeholder="请输入搜索内容"/>
    <div class="search-btn clear"><i class="iconfont icon-guanbi"></i></div>
    <div class="search-btn find"><i class="iconfont icon-sousuo"></i></div>
  </div>
  <div class="result">
    <ul class="result-content"></ul>
  </div>
</div>
    <div class="icon-menu"><i class="iconfont icon-m_menu"></i></div>
    <nav class="site-nav">
        <ul class="menu layui-nav">
            
            
            <li class="menu-item layui-nav-item">
                <a href="/" rel="section">
                    <i class="iconfont icon-home"></i>首页<i class="iconfont icon-header-mobile icon-right"></i>
                </a>
            </li>
            
            

            
            

            
            
                
                
                
                    
                        
                        
                            
                            <li class="menu-item layui-nav-item">
                                <a href="/categories/%E6%9D%82%E6%96%87/">
                                    杂文
                                    <i class="iconfont icon-header-mobile icon-right"></i>
                                </a>
                            </li>
                        
                        
                        
                    
                
                    
                        
                        
                            
                            <li class="menu-item layui-nav-item">
                                <a href="/categories/Python/">
                                    Python
                                    <i class="iconfont icon-header-mobile icon-right"></i>
                                </a>
                            </li>
                        
                        
                        
                    
                
                    
                        
                        
                            
                            <li class="menu-item layui-nav-item">
                                <a href="/categories/Gis/">
                                    Gis
                                    <i class="iconfont icon-header-mobile icon-right"></i>
                                </a>
                            </li>
                        
                        
                        
                    
                
                    
                        
                        
                            
                            <li class="menu-item layui-nav-item">
                                <a href="/categories/Asp/">
                                    Asp
                                    <i class="iconfont icon-header-mobile icon-right"></i>
                                </a>
                            </li>
                        
                        
                        
                    
                
                    
                        
                        
                            
                            <li class="menu-item layui-nav-item">
                                <a href="/categories/%E8%BD%AF%E4%BB%B6/">
                                    软件
                                    <i class="iconfont icon-header-mobile icon-right"></i>
                                </a>
                            </li>
                        
                        
                        
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                
                <li class="more menu-item layui-nav-item">
                    
                    <a href="javascript:;" class="menu-more">
                        更多分类
                        <i class="iconfont icon-header-mobile icon-sidemenu"></i>
                    </a>
                    
                    <dl class="layui-nav-child">
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                        
                            
                            
                                
                                
                                    
                                    <dd class="nav-child">
                                        <a href="/categories/Java/">
                                            Java
                                            <i class="iconfont icon-header-mobile icon-right"></i>
                                        </a>
                                    </dd>
                                
                            
                        
                            
                            
                                
                                
                                    
                                    <dd class="nav-child">
                                        <a href="/categories/%E5%89%8D%E7%AB%AF/">
                                            前端
                                            <i class="iconfont icon-header-mobile icon-right"></i>
                                        </a>
                                    </dd>
                                
                            
                        
                            
                            
                                
                                
                                    
                                    <dd class="nav-child">
                                        <a href="/categories/Javascript/">
                                            Javascript
                                            <i class="iconfont icon-header-mobile icon-right"></i>
                                        </a>
                                    </dd>
                                
                            
                        
                            
                            
                                
                                
                                    
                                    <dd class="nav-child">
                                        <a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">
                                            数据库
                                            <i class="iconfont icon-header-mobile icon-right"></i>
                                        </a>
                                    </dd>
                                
                            
                        
                            
                            
                                
                                
                                    
                                    <dd class="nav-child">
                                        <a href="/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/">
                                            操作系统
                                            <i class="iconfont icon-header-mobile icon-right"></i>
                                        </a>
                                    </dd>
                                
                            
                        
                            
                            
                                
                                
                                    
                                    <dd class="nav-child">
                                        <a href="/categories/Nodejs/">
                                            Nodejs
                                            <i class="iconfont icon-header-mobile icon-right"></i>
                                        </a>
                                    </dd>
                                
                            
                        
                            
                            
                                
                                
                                    
                                    <dd class="nav-child">
                                        <a href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/">
                                            大数据
                                            <i class="iconfont icon-header-mobile icon-right"></i>
                                        </a>
                                    </dd>
                                
                            
                        
                            
                            
                                
                                
                                    
                                    <dd class="nav-child">
                                        <a href="/categories/%E5%90%8E%E5%8F%B0%E6%9C%8D%E5%8A%A1/">
                                            后台服务
                                            <i class="iconfont icon-header-mobile icon-right"></i>
                                        </a>
                                    </dd>
                                
                            
                        
                            
                            
                                
                                
                                    
                                    <dd class="nav-child">
                                        <a href="/categories/%E9%9A%8F%E7%AC%94/">
                                            随笔
                                            <i class="iconfont icon-header-mobile icon-right"></i>
                                        </a>
                                    </dd>
                                
                            
                        
                            
                            
                                
                                
                                    
                                    <dd class="nav-child">
                                        <a href="/categories/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/">
                                            机器学习
                                            <i class="iconfont icon-header-mobile icon-right"></i>
                                        </a>
                                    </dd>
                                
                            
                        
                            
                            
                                
                                
                                    
                                    <dd class="nav-child">
                                        <a href="/categories/%E5%85%B6%E4%BB%96/">
                                            其他
                                            <i class="iconfont icon-header-mobile icon-right"></i>
                                        </a>
                                    </dd>
                                
                            
                        
                    </dl>
                </li>
            
        </ul>
    </nav>
</div></div>
    </header>
    
    <main class="main-content layui-fluid" id="main-content">
      <div class="main-inner">
        
  <div class="layui-row layui-col-space15">
    <div class="layui-col-xs12 layui-col-sm10 layui-col-sm-offset1 layui-col-md6 layui-col-md-offset2 layui-col-lg6 layui-col-lg-offset2">
        <div class="container post_wrap">
          <div class="post">
            <div class="article">
              <h1 class="title">技术研究之正射影像</h1>
              <div class="author">
                <span class="tag">标签：
                  

                  
                    无
                  
                </span>
                <span class="tag">分类：
                  

                  
                    未分类
                  
                </span>
                <span class='tag'>
                  创建时间：2024-11-22 09:38:34
                </span>
                <span class='tag'>
                  更新时间：2025-04-28 14:37:41
                </span>
              </div>
              <div class="content">
                <html><head></head><body><h1 id="1-前言"><a href="#1-前言" class="headerlink" title="1.前言"></a>1.前言</h1><p>在做庚保项目的时候，会涉及到无人机正射影像的问题。</p>
<ul>
<li>1.OpenDroneMap</li>
<li>2.PhotoScan</li>
<li>3.Pix4dmapper</li>
<li>4.ENVI OneButton</li>
</ul>
<div class="reference">参考文章:<br>【1】.<a target="_blank" rel="noopener" href="http://www.baiguangnan.com/2018/06/03/dronephotoscreatedom1/">利用无人机拼接正射影像图(一) </a> 这是飞无人机的正射影像操作，下一步还有拼接正射影像。<br>【2】.<a target="_blank" rel="noopener" href="http://www.baiguangnan.com/2018/06/04/dronephotoscreatedom2/">利用无人机拼接正射影像图(二) </a> 这里使用了 PhotoScan进行了正射影像的拼接</div>
<h1 id="2-无人机"><a href="#2-无人机" class="headerlink" title="2.无人机"></a>2.无人机</h1><p>可以通过无人机手柄设置 正射影像数据范围，然后进行正射影像的生成。</p>
<div class="reference">参考文章:<br>【1】.<a target="_blank" rel="noopener" href="https://bbs.dji.com/pro/detail?tid=216819">用大疆无人机获取目标范围正射影像</a> 设置测区范围，生成航线。</div>
<h1 id="2-OpenDroneMap"><a href="#2-OpenDroneMap" class="headerlink" title="2.OpenDroneMap"></a>2.OpenDroneMap</h1><p><a target="_blank" rel="noopener" href="https://www.opendronemap.org/">OpenDroneMap™</a> 这个是一个开源的项目，提供了很多的途径使用，包括：WebODM、NodeODM、CloudODM、PyODM、ClusterODM、NodeMICMAC、FIELDimageR、Find-GCP，操作方法。</p>
<div class="reference">参考文章:<br>【1】.<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=MzUzNDc0NjQ5NA==&amp;mid=2247484330&amp;idx=1&amp;sn=2fd17bbb9d9117344c3c0769a6a8bd21&amp;source=41#wechat_redirect">如何使用OpenDroneMap对航拍图像快速建模 </a> Docker 的运行指令。-it 指让 Docker 分配一个伪输入终端并以交互模式运行容器；–rm 是指在容器运行完之后自动清除以节省电脑存储空间。<br>【2】.<a target="_blank" rel="noopener" href="https://m.fx361.com/news/2020/0516/11710031.html">基于ODM和Cesium的无人机倾斜摄影建模及可视化</a> 这是一篇论文，通过docker-java启动了opendronemap，进行了图像拼接。本文通过研究Web应用系统和三维GIS技术，结合三维GIS集成无人机数据处理的需求，对无人机数据处理和可视化系统进行研究与设计。本文提出的系统方案釆用当前前沿的三维WebGIS技术，该结构各部分组件之间配合良好，功能强大，主要数据处理部分ODM通过docker-java封装，单独与Java Spring框架结合划分微服务，方便开发调用和扩展。基于Java Spring框架与开源WebGIS技术结合起来，在 Web应用系统通用功能方面釆用 Springboot+Mybatis+Vuejs的架构确保了平台的安全性，完整性、可移植性和可扩展性。在GIS特有功能实现上采用PostGIS作为空间数据库，GeoServer作为地图应用服务器，采用 GeoWebCache为地图缓存[5]，以Cesium为客户端。以Tomcat为Web服务器搭建完成了无人机数据处理系统。</div>
<h2 id="2-1-安装"><a href="#2-1-安装" class="headerlink" title="2.1.安装"></a>2.1.安装</h2><p>这里我使用了 docker 安装了 odm ，至于这个网络问题，我真是费了好大的劲，就是无法下载这个镜像，最后只能挂代理的方式把这个镜像下载下来。</p>
<figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull opendronemap/odm</span><br></pre></td></tr></tbody></table></figure>

<div class="reference">参考文章:<br>【1】.<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_60320488/article/details/142432945">Opendronemap的docker使用</a><br>【2】.<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_47503016/article/details/127076636">桌面版docker设置代理</a> 这里设置了代理。<br>【3】.<a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/2434428">国内无法拉取Docker镜像了？这些方法拯救你的Docker</a> 1.某些云镜像加速。2.使用Docker Hub并将镜像推送到阿里云自有仓库。3.使用Github Action 构建docker镜像。4.部署DockerHub的代理。5.镜像仓库前缀替换。</div>
<h2 id="2-2-使用"><a href="#2-2-使用" class="headerlink" title="2.2.使用"></a>2.2.使用</h2><p>使用docker命令就可以直接获取相关的内容：</p>
<ul>
<li>odm_meshing # 3D 网面建模</li>
<li>odm_texturing # 纹理网面建模</li>
<li>odm_georeferencing # 地理配准后的点云图</li>
<li>odm_orthophoto # 正射影像图</li>
<li>odm_report # 程序运行报告</li>
</ul>
<figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># linux 使用</span></span><br><span class="line">docker run -it --<span class="built_in">rm</span> \</span><br><span class="line">    -v $(<span class="built_in">pwd</span>)/images:/code/images \</span><br><span class="line">    -v $(<span class="built_in">pwd</span>)/odm_orthophoto:/code/odm_orthophoto \</span><br><span class="line">    -v $(<span class="built_in">pwd</span>)/odm_texturing:/code/odm_texturing \</span><br><span class="line">    opendronemap/odm</span><br><span class="line"></span><br><span class="line"><span class="comment"># window 11 生成正射影像</span></span><br><span class="line">docker run -it --<span class="built_in">rm</span>  -v D:/zlc/drone/resources/images:/code/images -v D:/zlc/drone/resources/odm_orthophoto:/code/odm_orthophoto opendronemap/odm</span><br><span class="line">```     </span><br><span class="line"></span><br><span class="line">参考文章:</span><br><span class="line">【1】.[docker run 参数详解](https://www.jianshu.com/p/40ed20b177af) 运行一个在后台执行的容器，同时，还能用控制台管理：docker run -i -t -d ubuntu:latest</span><br><span class="line">【2】.[OpenDroneMap (ODM) 安装和配置指南](https://blog.csdn.net/gitblog_07918/article/details/142233384) 1.处理完成后，结果将存储在以下目录结构中.2.使用开源软件查看结果:GeoTIFF (.tif): 使用 QGIS 打开,Compressed LAS (.laz): 使用 CloudCompare 打开,Wavefront OBJ (.obj): 使用 MeshLab 打开,Stanford Triangle Format (.ply): 使用 MeshLab 打开。</span><br><span class="line"></span><br><span class="line"><span class="comment">## 2.3.Python</span></span><br><span class="line">除了 docker，还可以使用 python 进行安装使用，好像比使用 docker 更加的方便。</span><br><span class="line">```sh</span><br><span class="line"><span class="comment"># 克隆仓库</span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/OpenDroneMap/ODM.git</span><br><span class="line"><span class="built_in">cd</span> ODM</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装依赖</span></span><br><span class="line">pip install -r requirements.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行 ODM 处理图像</span></span><br><span class="line">python run.py --project-path /path/to/your/images</span><br></pre></td></tr></tbody></table></figure>

<div class="reference">参考文章:<br>【1】.<a target="_blank" rel="noopener" href="https://blog.csdn.net/gitblog_00422/article/details/141043067">OpenDroneMap (ODM) 开源项目教程</a> 这里介绍了使用 python<br>【2】.<a target="_blank" rel="noopener" href="https://juejin.cn/post/6844903807894175751">ODM - 一个开源的命令行工具来生成、展示无人机构建的 3D 地图模型 </a></div>
<h2 id="2-4-docker-java"><a href="#2-4-docker-java" class="headerlink" title="2.4.docker-java"></a>2.4.docker-java</h2><p>使用 java 操作 docker，这种方式有些麻烦，需要先把 docker http 的接口打开，打开之后就可以通过 API 进行调用了。这种方式其实也挺麻烦的，还需要处理权限校验的问题。</p>
<p>(1) 添加依赖</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.docker-java<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>docker-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.4.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<p>(2) 创建容器<br>通过代码创建一个 Docker </p>
<div class="reference">参考文章:<br>【1】.<a target="_blank" rel="noopener" href="https://www.cnblogs.com/beyond-tester/p/17896443.html">Java API 操作Docker浅谈</a> 1.创建Docker客户端。2.创建镜像。3.创建容器。4.启动容器。5.停止和删除容器。<br>【2】.<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_41885266/article/details/130561780">在Java中执行docker命令</a> 在Java中执行docker命令可以使用Java的Runtime类或ProcessBuilder类。<br>【3】.<a target="_blank" rel="noopener" href="https://blog.51cto.com/u_16175447/8223274">java代码执行docker命令 </a> 这里使用了 docker-java 依赖，然后有一个 withCmd 参数。1.引入 Docker 的 Java API 包。2.创建 Docker 客户端连接。3.创建 Docker 容器。4.启动 Docker 容器。5.     执行 Docker 命令。6.停止 Docker 容器。7.删除 Docker 容器。8.关闭 Docker 客户端连接。<br>【4】.<a target="_blank" rel="noopener" href="https://zhuanlanjia.com/post/219">使用Java Client API安全地远程调用Docker API</a> 默认 docker 只允许本机使用docker命令进行操作，我们现在来开启 http api 调用，使得其他机器可以通过 http 请求来操作 docker。</div>
<h2 id="2-5-java命令行"><a href="#2-5-java命令行" class="headerlink" title="2.5.java命令行"></a>2.5.java命令行</h2><p>使用命令行的方式，其实更加的简单，直接通过 Runtime.getRuntime() 命令执行就可以了，假定已经 通过 docker pull 拉取了 opendronemap/odm 的镜像。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">photoPath</span> <span class="operator">=</span> resource + <span class="string">"/orthophoto/"</span>+uuid;</span><br><span class="line"><span class="keyword">try</span> {</span><br><span class="line">    <span class="comment">// 创建ProcessBuilder</span></span><br><span class="line">    String cmd=<span class="string">"docker run -i --rm  -v "</span>+photoPath+<span class="string">"/images:/code/images -v "</span>+photoPath+<span class="string">"/odm_orthophoto:/code/odm_orthophoto opendronemap/odm"</span>;</span><br><span class="line">    <span class="type">Runtime</span> <span class="variable">run</span> <span class="operator">=</span> Runtime.getRuntime();</span><br><span class="line">    <span class="comment">// 启动进程</span></span><br><span class="line">    <span class="type">Process</span> <span class="variable">process</span> <span class="operator">=</span>run.exec(cmd);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取命令的输出</span></span><br><span class="line">    <span class="type">BufferedReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(process.getInputStream()));</span><br><span class="line">    String line;</span><br><span class="line">    <span class="keyword">while</span> ((line = reader.readLine()) != <span class="literal">null</span>) {</span><br><span class="line">        System.out.println(line);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// 等待命令执行完成</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">exitCode</span> <span class="operator">=</span> process.waitFor();</span><br><span class="line">    log.info(<span class="string">"cmd：{}，exit code: {}"</span>,cmd, exitCode);</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 打印异常</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">FileInputStream</span> <span class="variable">errorStream</span> <span class="operator">=</span> (FileInputStream)process.getErrorStream();</span><br><span class="line">    <span class="type">InputStreamReader</span> <span class="variable">isr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(errorStream,<span class="string">"gbk"</span>);<span class="comment">//读取</span></span><br><span class="line">    <span class="type">BufferedReader</span> <span class="variable">bufr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(isr);<span class="comment">//缓冲</span></span><br><span class="line">    String errline;</span><br><span class="line">    <span class="keyword">while</span>((errline =bufr.readLine())!=<span class="literal">null</span>) {</span><br><span class="line">        log.error(<span class="string">"docker error：{}"</span>,errline);</span><br><span class="line">    }</span><br><span class="line">    isr.close();</span><br><span class="line">} <span class="keyword">catch</span> (IOException | InterruptedException e) {</span><br><span class="line">    log.error(<span class="string">"OrthophotoUtil：{}"</span>,e.getMessage());</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<div class="reference">参考文章:<br>【1】.<a target="_blank" rel="noopener" href="https://blog.csdn.net/xuecancan/article/details/79389496">Java 执行cmd程序，并获取命令行内容</a> java中的RunTime类，每个java程序都有一个RunTme的运行实例，能够使运行程序与其运行的环境相连接。Process 类能够创建本地进程，也可以通过RunTime的实例exec()方法创建。Process 的 getInputStream() 会获取窗体命令执行的结果，可以把它转化成字符串进行输出。<br>【2】.<a target="_blank" rel="noopener" href="https://blog.51cto.com/u_16213446/12235554">Java Process执行cmd命令是异步的吗</a><br>【3】.<a target="_blank" rel="noopener" href="https://blog.csdn.net/cainiaobulan/article/details/82844522">java多线程run方法传参</a><br>【4】.<a target="_blank" rel="noopener" href="https://www.bvmem.com/archives/1093">java调用命令行工具</a> 1.ProcessBuilder方式。2.Runtime#exec执行。<br>【5】.<a target="_blank" rel="noopener" href="https://blog.csdn.net/yaya_jn/article/details/126418888">Java中Process和Runtime()使用，以及调用cmd命令阻塞解决</a> java调用cmd执行bat文件有时会出现卡死的现象，当时感觉很迷惑，后来查资料，本来一般都是这样来调用程序并获取进程的输出流的，但是我在windows上执行这样的调用的时候却总是在while那里被堵塞了，结果造成ffmpeg程序在执行了一会后不再执行，这里从官方的参考文档中我们可以看到这是由于缓冲区的问题，由于java进程没有清空ffmpeg程序写到缓冲区的内容，结果导致ffmpeg程序一直在等待。<br>【6】.<a target="_blank" rel="noopener" href="https://blog.csdn.net/xgysimida/article/details/117373179">Java程序调用Docker命令并获取输出</a> 开发一个可以在服务器调用Docker命令的Java程序，然后build成jar包，直接丢到服务器跑<br>【7】.<a target="_blank" rel="noopener" href="https://www.cnblogs.com/wzhanke/p/4792495.html">关于JAVA Project.waitfor()返回值是1</a></div>
<h2 id="2-6-python命令行"><a href="#2-6-python命令行" class="headerlink" title="2.6.python命令行"></a>2.6.python命令行</h2><p>除了可以使用 java 执行命令行，还可以使用 python 执行命令行。</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">执行命令</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">execute_command</span>(<span class="params">self,command</span>):</span><br><span class="line">    log.error(<span class="string">"执行命令：{}"</span>,command)</span><br><span class="line">    result = subprocess.run(command, shell=<span class="literal">True</span>, capture_output=<span class="literal">True</span>, text=<span class="literal">True</span>)</span><br><span class="line">    <span class="keyword">if</span> result.returncode == <span class="number">0</span>:</span><br><span class="line">        log.info(result.stdout)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        log.error(result.stderr)</span><br><span class="line">    <span class="keyword">return</span> result.returncode</span><br><span class="line"></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">或者</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">execute_command</span>(<span class="params">self,command</span>):</span><br><span class="line">    log.error(<span class="string">"执行命令：{}"</span>,command)</span><br><span class="line">    result = subprocess.Popen(command, shell=<span class="literal">True</span>, text=<span class="literal">True</span>, stdout=subprocess.PIPE, stderr=subprocess.STDOUT, encoding=<span class="string">"utf-8"</span>)</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        rt_data = result.stdout.readline()</span><br><span class="line">        <span class="keyword">if</span> rt_data != <span class="string">""</span>:</span><br><span class="line">            <span class="built_in">print</span>(rt_data,end=<span class="string">""</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">return</span> result.wait() <span class="comment">#执行成功返回0，执行失败返回1</span></span><br><span class="line"></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">或者</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">execute_command</span>(<span class="params">self,command</span>):</span><br><span class="line">    log.error(<span class="string">"执行命令：{}"</span>,command)</span><br><span class="line">    <span class="comment"># 得到一个临时文件对象， 调用close后，此文件从磁盘删除</span></span><br><span class="line">    out_temp = tempfile.TemporaryFile(mode=<span class="string">'w+'</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># result = subprocess.Popen(command, shell=True, text=True, stdout=subprocess.PIPE, stderr=subprocess.STDOUT, encoding="utf-8")</span></span><br><span class="line">        <span class="comment"># 获取临时文件的文件号</span></span><br><span class="line">        fileno = out_temp.fileno()</span><br><span class="line">        p = subprocess.Popen(command,shell=<span class="literal">True</span>, text=<span class="literal">True</span>, stdout=fileno, stderr=fileno, encoding=<span class="string">"utf-8"</span>)</span><br><span class="line">        <span class="keyword">while</span> p.poll() <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            out_temp.seek(<span class="number">0</span>)  <span class="comment"># 表示从文件开头开始读取；用于在文件中移动文件指针的位置</span></span><br><span class="line">            output = out_temp.read()</span><br><span class="line">            data = output.strip()</span><br><span class="line">            <span class="keyword">if</span> data:</span><br><span class="line">                log.info(data)</span><br><span class="line">        <span class="comment"># 执行成功返回0，执行失败返回1</span></span><br><span class="line">        <span class="keyword">if</span> p.returncode != <span class="number">0</span>:</span><br><span class="line">            log.error(<span class="string">"命令行执行失败"</span>,p.returncode)</span><br><span class="line">        <span class="keyword">return</span> p.returncode</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        log.error(e)</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        <span class="keyword">if</span> out_temp:</span><br><span class="line">            out_temp.close()</span><br><span class="line">    <span class="keyword">return</span> -<span class="number">1</span></span><br></pre></td></tr></tbody></table></figure>

<div class="reference">参考文章:<br>【1】.<a target="_blank" rel="noopener" href="https://www.runoob.com/w3cnote/python3-subprocess.html">Python3 subprocess</a> 这里将错误输出和正确输出都放到一个管道里面了<br>【2】.<a target="_blank" rel="noopener" href="https://www.cnblogs.com/rychh/articles/11386508.html">Python_多进程_subprocess（含标准输入、输出、错误输出）</a><br>【3】.<a target="_blank" rel="noopener" href="https://blog.csdn.net/xiekaikaibing/article/details/82758582">python：输出subprocess中子进程的运行信息</a><br>【4】.<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_33704787/article/details/124755072">Python 执行cmd命令的3种方法简单示例，并获取返回信息、执行命令结果（成功 or 失败）</a> 这里有错误码相关的说明。<br>【5】.<a target="_blank" rel="noopener" href="https://blog.csdn.net/luwieer/article/details/140680977">Python使用subprocess模块时隐藏输出与显示错误的参数设置方法</a><br>【6】.<a target="_blank" rel="noopener" href="https://www.cnblogs.com/hardfood/p/15663981.html">Python获取控制台输出点方法</a> 1.非实时输出：subprocess.run。2.实时输出 subprocess.Popen。<br>【7】.<a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/2388843">记录Python 调用 subprocess.Popen 卡死解决办法</a> 这里用了 run 方法替代了 Popen 方法。stderr=subprocess.STDOUT：将子进程的标准错误输出合并到标准输出中。shell=True：表示通过系统的 shell 来执行命令，可以使用命令的通配符、管道等功能。<br>【8】.<a target="_blank" rel="noopener" href="https://www.cnblogs.com/slqt/p/10362527.html">Python调用subprocess.Popen卡死的解决方案</a> 这里定义了一个 tempfile.SpooledTemporaryFile(bufsize=10*1000)，自定义输出内容大小<br>【9】.<a target="_blank" rel="noopener" href="https://www.cnblogs.com/chybot/p/5176118.html">python Popen卡死问题</a> 原因是使用Popen.wait()后直接读PIPE.stdout.read()之前，可能缓存已经满了，此时导致了卡死。解决办法：使用communicate()，最后在调用Popen的时候加上参数close_fds=True。<br>【10】.<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44701654/article/details/133267456">解决Popen运行程序buff存满、通道阻塞导致进程卡死问题</a> 创建一个临时文件，把输出结果存到临时文件中,从临时文件中读取结果<br>【11】.<a target="_blank" rel="noopener" href="https://dothinking.github.io/2018-01-12-%E4%BD%BF%E7%94%A8subprocess%E6%A8%A1%E5%9D%97%E8%B0%83%E7%94%A8%E5%AD%90%E8%BF%9B%E7%A8%8B%E5%B9%B6%E8%8E%B7%E5%8F%96%E8%BE%93%E5%87%BA/">使用subprocess模块调用子进程并获取输出</a><br>【12】.<a target="_blank" rel="noopener" href="https://blog.csdn.net/To_ChaRiver/article/details/119720207">python3 subprocess.Popen监控控制台输出</a>  如下所示为本例参考代码。使用 Python3 内置模块 subprocess.Popen 建立channel 。设定参数encoding=’utf8’，转码简体中文。设定universal_newlines=True以及bufsize=1建立缓冲区，以便捕获频繁刷新的进度条等特征信息。</div>
<h2 id="2-7-GPU"><a href="#2-7-GPU" class="headerlink" title="2.7.GPU"></a>2.7.GPU</h2><p>最近几次我尝试生成正射影像，我发现cpu总是跑满的，i9-12900k 也不行。</p>
<figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -ti --<span class="built_in">rm</span> -v c:/Users/youruser/datasets:/datasets --gpus all opendronemap/odm:gpu --project-path /datasets project</span><br></pre></td></tr></tbody></table></figure>

<div class="reference">参考文章:<br>【1】.<a target="_blank" rel="noopener" href="https://gitee.com/mirrors/odm?skip_mobile=true#gpu-acceleration">GPU Acceleration</a></div>
<h1 id="3-切片"><a href="#3-切片" class="headerlink" title="3.切片"></a>3.切片</h1><p>我本来想着是使用java调用 gdal 执行影像金字塔的构建，但是查了很多的资料，好像都没有具体的代码，更多的都是使用 python 进行切片，比如：</p>
<ul>
<li><p><a target="_blank" rel="noopener" href="https://github.com/tehamalab/gdal2tiles">gdal2tiles </a><br>python写的gdal转成tiles工具，在四年前就停止更新了，可能就是整个的工具的作用都已经完成了吧。</p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://blog.51cto.com/u_16213698/10820277">gdal2tiles将tif转瓦片 gdal瓦片切片工具</a><br>这篇文章也是使用了 python 进行了切片操作，是gdal2tiles 的改版，支持火星偏移、默认改为谷歌瓦片模式(/z/x/y)，原来是/z/x/-y、支持瓦片压缩、需要安装gdal和pngquant(如果需要压缩的话）。</p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/jackspring2010/article/details/120919090">一个简单的影像切片工具，生成xyz格式</a><br>这里写了一个工具，可以设置切片的路径，还有切片的层级，文章倒是用的java代码。</p>
</li>
</ul>
<p>经过不懈的努力，最后我还是找不到更好的方案，只能用python了，虽然已经多年没有更新了，但是还是有人在用的。</p>
<div class="reference">参考文章:<br>【1】.<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_42687675/article/details/129035489">TIF影像图进行切片处理及加载</a> 1.tif格式介绍；2.tif格式介绍；3.常见问题；4.处理操作流程完整示例：准备好tif格式文件、准备好tif格式文件、发布三维数据为HTTP服务，因为地图瓦片数据一般都很大，建议将瓦片目录发布为http服务可以访问的一个站点，操作方式参考nginx、IIS、Tomcat等Http服务器操作说明， 可以参考教程发布三维数据服务<br>【2】.<a target="_blank" rel="noopener" href="https://blog.csdn.net/wjdhnn/article/details/115536841">影像切片</a> 1.影像切片。2.瓦片存储原理。3.任意范围瓦片。4.GeoTools切片思路。<br>【3】.<a target="_blank" rel="noopener" href="https://blog.csdn.net/oYinHeZhiGuang/article/details/121595708">基于geotools实现geotif切瓦片</a> 这里用了 geotools 进行了图像切片，但是只是进行了切割，没有形成金字塔。<br>【4】.<a target="_blank" rel="noopener" href="http://www.weizhi.cc/tech/detail-309415.html">开源影像tif切图工具gdal2tiles部署以及切图</a> 这里使用了 GDAL 进行了切片，还有GDAL的安装。1.下载gdal的whl文件安装包，下载版本跟本机安装的python版本匹配就行。2.运行测试gdal2tiles.py切图工具.<br>【5】.<a target="_blank" rel="noopener" href="https://www.giserdqy.com/test/37581/">基于GDAL的影像切图工具</a> 1.首先获取原始影像的地理坐标范围。2.获取原始影像的像素分辨率。3.根据原始影像地理范围求解切片行列号。4.求原始影像地理范围与指定缩放级别指定行列号的切片交集。5.求解当前切片的像素分辨率(默认切片大小为256*256)。6.计算交集的像素信息。7.使用GDAL的ReadRaster方法对影像指定范围进行读取与压缩。。8.将切片数据写入文件。9.读取临时文件，并转换成二进制存储到SQLite。<br>【6】.<a target="_blank" rel="noopener" href="https://blog.51cto.com/u_16175465/9773119">Java实现tif切片</a> 这里只是把tif切成了小的png，没有进行层级组织。<br>【7】.<a target="_blank" rel="noopener" href="https://blog.51cto.com/u_16175449/8163647">java 集成gdal 进行切片</a> 在进行切片之前，你需要打开要切片的数据源。数据源可以是一个图像文件、一个数据库或一个网络服务。你可以使用GDAL的gdal.Open()方法来打开数据源。在进行切片之前，你需要设置切片的参数，包括切片的范围、切片的大小和切片的格式等。你可以使用GDAL的gdal.TranslateOptions类来设置这些参数。<br>【8】.<a target="_blank" rel="noopener" href="https://blog.csdn.net/wangshuminjava/article/details/117671048">gdal栅格切图</a> 这里使用的是 gdal 进行的切片，全部都是代码，没啥解释，然后执行了 sqlite 存储，问题出在就是没有如何创建 sqlite数据库和进行数据库连接的代码。<br>【9】.<a target="_blank" rel="noopener" href="http://www.weizhi.cc/tech/detail-309415.html">开源影像tif切图工具gdal2tiles部署以及切图</a></div>
<h2 id="3-1-安装gdal"><a href="#3-1-安装gdal" class="headerlink" title="3.1.安装gdal"></a>3.1.安装gdal</h2><p>（1）windows 上安装<br>在<a target="_blank" rel="noopener" href="https://github.com/cgohlke/geospatial-wheels/releases">新的地址上</a>下载 gdal 的版本，安装，因为我的python版本是3.9，所以我选择了  GDAL-3.9.2-cp39-cp39-win_amd64.whl 这个版本。</p>
<figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install  GDAL-3.9.2-cp39-cp39-win_amd64.whl </span><br></pre></td></tr></tbody></table></figure>

<p>（2）linux上安装<br>直接使用 conda 安装，我也尝试使用 pip 安装，但是不成功，我尝试下载了 whl安装，结果也不行。</p>
<figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">conda install gdal</span><br></pre></td></tr></tbody></table></figure>

<div class="reference">参考文章:<br>【1】.<a target="_blank" rel="noopener" href="https://blog.csdn.net/brucehaoLee/article/details/140928493">通过【OSGeo4W】安装【gdal】库的流程与问题</a><br>【2】.<a target="_blank" rel="noopener" href="https://gdal.org/en/stable/download.html#binaries">Binaries</a> 这个是 gdal 的官方安装说明。<br>【3】.<a target="_blank" rel="noopener" href="https://www.cnblogs.com/haijian/p/17240947.html">linux 安装 gdal python</a> 下载相应的GDAL-3.4.1-cp39-cp39-manylinux_2_5_x86_64.xxx.whl，然后安装<br>【4】.<a target="_blank" rel="noopener" href="https://www.idc.net/help/113241/">Linux系统中如何快速安装GDAL（gdal linux安装）</a> 1.安装必要的依赖库;2.下载并安装GDAL库;3.安装Python相关GDAL依赖库;4.检查GDAL安装。<br>【5】.<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_39312908/article/details/121648768">linux下python安装gdal库</a> 使用pip安装，import会报错，每次还不一样，很难解决。直接使用 conda 安装。</div>
<h2 id="3-2-安装-gdal2tiles"><a href="#3-2-安装-gdal2tiles" class="headerlink" title="3.2.安装 gdal2tiles"></a>3.2.安装 gdal2tiles</h2><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install gdal2tiles</span><br></pre></td></tr></tbody></table></figure>

<div class="reference">参考文章:<br>【1】.<a target="_blank" rel="noopener" href="https://www.osgeo.cn/gdal/programs/gdal2tiles.html">gdal2tiles.py</a>  –xyz,生成XYZ平铺（OSM滑动贴图标准）而不是TMS。在默认模式（TMS）中，y=0处的瓦片是最南端的瓷砖，而在XYZ模式（OGC WMTS也使用）中，y=0处的瓷砖是最北端的瓦片。</div>
<h2 id="3-3-切片"><a href="#3-3-切片" class="headerlink" title="3.3.切片"></a>3.3.切片</h2><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> gdal2tiles</span><br><span class="line"></span><br><span class="line">gdal2tiles.generate_tiles(<span class="string">'/path/to/input_file'</span>, <span class="string">'/path/to/output_dir/'</span>)</span><br><span class="line"><span class="comment"># 定义多线程</span></span><br><span class="line">gdal2tiles.generate_tiles(<span class="string">'input_file'</span>, <span class="string">'output_dir/'</span>, nb_processes=<span class="number">2</span>, zoom=<span class="string">'7-9'</span>)</span><br><span class="line"><span class="comment"># 或者</span></span><br><span class="line">options = {<span class="string">'zoom'</span>: (<span class="number">7</span>, <span class="number">9</span>), <span class="string">'resume'</span>: <span class="literal">True</span>}</span><br><span class="line">gdal2tiles.generate_tiles(<span class="string">'input_file'</span>, <span class="string">'output_dir/'</span>, **options)</span><br></pre></td></tr></tbody></table></figure>

<h2 id="3-4-进阶"><a href="#3-4-进阶" class="headerlink" title="3.4.进阶"></a>3.4.进阶</h2><p>继续的发展，就是使用改造的 gdal2tiles 进行切片。</p>
<h1 id="4-发布"><a href="#4-发布" class="headerlink" title="4.发布"></a>4.发布</h1><p>本来我想着要用静态文件 xyz png 格式进行存储，后来我发现，不少文章是直接存在 sqlite 数据库中的。<a target="_blank" rel="noopener" href="https://blog.csdn.net/zhangzhw_zzw/article/details/126390793">Springboot发布/{z}/{x}/{y}.png地图瓦片服务</a> 这里其实只是写了一个读取切片文件然后返回的例子,也就是说地图瓦片已经切好了，直接按照目录进行存储，然后读取就好了。就是使用上一步中用 gdal2tiles 进行切片后得到的数据，进行服务发布的过程。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sailen.tpm.modules.signal.config.TpmConfig;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PathVariable;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> javax.imageio.ImageIO;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.awt.image.BufferedImage;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.util.Optional;</span><br><span class="line"> </span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping("/map")</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MapPublicController</span> {</span><br><span class="line">    </span><br><span class="line"> </span><br><span class="line">    <span class="meta">@GetMapping("/{layer}/{level}/{col}/{row}")</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">xyz</span><span class="params">(<span class="meta">@PathVariable</span> String layer, <span class="meta">@PathVariable</span> String level, <span class="meta">@PathVariable</span> String col,</span></span><br><span class="line"><span class="params">                    <span class="meta">@PathVariable</span> String row, HttpServletResponse response)</span> {</span><br><span class="line">        <span class="type">String</span> <span class="variable">dataPath</span> <span class="operator">=</span> <span class="string">"your data path"</span>;</span><br><span class="line">        <span class="type">StringBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>(dataPath);</span><br><span class="line">        buffer.append(<span class="string">"/"</span>).append(layer)</span><br><span class="line">                .append(<span class="string">"/"</span>).append(level)</span><br><span class="line">                .append(<span class="string">"/"</span>).append(col)</span><br><span class="line">                .append(<span class="string">"/"</span>).append(row);</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="type">String</span> <span class="variable">tilePath</span> <span class="operator">=</span> buffer.toString();</span><br><span class="line">            <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(tilePath);</span><br><span class="line">            <span class="keyword">if</span> (Optional.of(inputStream).isPresent()) {</span><br><span class="line">                <span class="type">BufferedImage</span> <span class="variable">bi</span> <span class="operator">=</span> ImageIO.read(inputStream);</span><br><span class="line">                ImageIO.write(bi, <span class="string">"PNG"</span>, response.getOutputStream());</span><br><span class="line">                bi.flush();</span><br><span class="line">                inputStream.close();</span><br><span class="line">            }</span><br><span class="line">        } <span class="keyword">catch</span> (IOException e) {</span><br><span class="line">            System.out.println(String.format(<span class="string">"%s/%d/%d/%s请求瓦片出错!"</span>, layer, level, col, row));</span><br><span class="line">        }</span><br><span class="line">    } </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<div class="reference">参考文章:<br>【1】.<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_34447899/article/details/133344219">openlayers 加载nginx发布的松散型arcgis瓦片</a><br>【2】.<a target="_blank" rel="noopener" href="https://juejin.cn/post/7383971780945870885">Geo Atlas，用于构建矢量切片服务的Java基础库 </a> Geo Atlas，译为地理地图册(地理地图集)，就像小时候买到的纸质的地理地图册书本，里面填充着各式各样的地图。所以, 我也希望有那么一个东西，同样可以对外提供各种各样的地图以供使用。目前来说，他还只是一个基于Java的开发的，可用于快速构建矢量切片服务的基础库。<br>【3】.<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_47910339/article/details/141426396">使用Java往Geoserver发布tif图层和shp图层</a><br>【4】.<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_43031156/article/details/131803424">geotools实现wmts服务</a><br>【5】.<a target="_blank" rel="noopener" href="https://blog.51cto.com/u_16175449/8163647">java 集成gdal 进行切片</a> 你可以使用GDAL的gdal.Translate()方法来执行切片操作。这个方法会将数据源切片为一系列的图像文件，并保存到指定的目录中。<br>【6】.<a target="_blank" rel="noopener" href="https://github.com/luzhanov/geobricks/blob/master/geobricks/src/main/java/org/geobricks/gdal/gdal2tiles/GDAL2Tiles.java#L185">GDAL2Tiles.java</a> 这里的代码，我看着实际上使用的是java调用了python脚本，执行了切片操作。<br>【7】.<a target="_blank" rel="noopener" href="https://github.com/voole/gdal2tiles-2?tab=readme-ov-file">gdal2tiles-2 </a> gdal中python版gdal2tiles翻译为java版本，准备朝着MapTiler开发<br>【8】.<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_35582643/article/details/139403533">切片的MBTiles格式和XYZ格式</a><br>【9】.<a target="_blank" rel="noopener" href="https://github.com/maptiler/tileserver-gl/issues/424">Raster tile server using png data</a> .mbtiles is the only supported input format.You can use e.g. MapTiler Desktop (<code>https://www.maptiler.com/desktop/</code>) to process your image into .mbtiles.（.mbtiles是唯一的输入格式，可以使MapTiler将图片转换为.mbtiles）</div>
<h1 id="5-前端加载"><a href="#5-前端加载" class="headerlink" title="5.前端加载"></a>5.前端加载</h1><p>这里我使用了 vite，然后用了 openlayers 创建了一个请求。</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">'./style.css'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Map</span> <span class="keyword">from</span> <span class="string">'ol/Map.js'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="variable constant_">OSM</span> <span class="keyword">from</span> <span class="string">'ol/source/OSM.js'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">TileLayer</span> <span class="keyword">from</span> <span class="string">'ol/layer/Tile.js'</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">TileWMS</span> <span class="keyword">from</span> <span class="string">'ol/source/TileWMS.js'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">View</span> <span class="keyword">from</span> <span class="string">'ol/View.js'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="variable constant_">XYZ</span> <span class="keyword">from</span> <span class="string">'ol/source/XYZ.js'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> map = <span class="keyword">new</span> <span class="title class_">Map</span>({</span><br><span class="line">  <span class="attr">target</span>: <span class="string">'map'</span>,</span><br><span class="line">  <span class="attr">layers</span>: [</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">TileLayer</span>({</span><br><span class="line">        <span class="attr">source</span>: <span class="keyword">new</span> <span class="title function_">XYZ</span>({</span><br><span class="line">            <span class="attr">url</span>:<span class="string">"http://a.tile.osm.org/{z}/{x}/{y}.png"</span></span><br><span class="line">          }),</span><br><span class="line">    }),</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">TileLayer</span>({</span><br><span class="line">        <span class="attr">source</span>: <span class="keyword">new</span> <span class="title function_">XYZ</span>({</span><br><span class="line">            <span class="attr">tileUrlFunction</span>: <span class="keyword">function</span> (<span class="params">tileCoord</span>) {</span><br><span class="line">                <span class="keyword">let</span> z = tileCoord[<span class="number">0</span>];</span><br><span class="line">                <span class="keyword">let</span> x = tileCoord[<span class="number">1</span>];</span><br><span class="line">                <span class="keyword">let</span> y = <span class="title class_">Math</span>.<span class="title function_">pow</span>(<span class="number">2</span>, z) - tileCoord[<span class="number">2</span>] - <span class="number">1</span>;    </span><br><span class="line">                <span class="keyword">return</span> <span class="string">"http://localhost:5173/"</span> + z + <span class="string">"/"</span> + x + <span class="string">"/"</span> + y + <span class="string">".png"</span>;</span><br><span class="line">            }</span><br><span class="line">          }),</span><br><span class="line">    }),</span><br><span class="line"></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">view</span>: <span class="keyword">new</span> <span class="title class_">View</span>({</span><br><span class="line">    <span class="attr">projection</span>: <span class="string">'EPSG:4326'</span>,</span><br><span class="line">    <span class="attr">center</span>: [<span class="number">120.143937453271</span>,<span class="number">30.12599771681532</span>],</span><br><span class="line">    <span class="attr">zoom</span>: <span class="number">18</span>,</span><br><span class="line">  }),</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure>

<div class="reference">参考文章:<br>【1】.<a target="_blank" rel="noopener" href="https://blog.csdn.net/a873744779/article/details/122398131">Openlayers加载水晶注标准TMS瓦片</a> 这里有方法<br>【2】.<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_35732147/article/details/94973411">OpenLayers教程十二：多源数据加载之使用XYZ的方式加载瓦片地图</a> 这里是加载的xyz方式<br>【3】.<a target="_blank" rel="noopener" href="https://www.cnblogs.com/jiujiubashiyi/p/16063829.html">OpenLayers多源数据加载</a> 1.利用XYZ加载OSM数据；2.利用XYZ加载百度地图。<br>【4】.<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_35732147/article/details/95061747">OpenLayers教程十三：多源数据加载之详解OpenLayers的瓦片坐标系</a> 1.通过自定义OpenLayers的瓦片坐标系来加载百度地图。2.分析瓦片地图的瓦片坐标系。3.加载Google中文地图。<br>【5】.<a target="_blank" rel="noopener" href="https://www.cnblogs.com/ZerlinM/p/18339052">openlayers 使用WMTS和XYZ加载天地图切片服务</a><br>【6】.<a target="_blank" rel="noopener" href="https://blog.csdn.net/u014572215/article/details/109382398">openlayers学习（八）加载天地图各种底图</a> 这里加载了天地图<br>【7】.<a target="_blank" rel="noopener" href="https://blog.csdn.net/mati6929/article/details/129831383">GeoServer-权限认证-OpenLayers加载</a> 这里用了 tileLoadFunction 设置了权限。</div>
<h1 id="5-MbTiles"><a href="#5-MbTiles" class="headerlink" title="5.MbTiles"></a>5.MbTiles</h1><p>MbTiles不是一个数据库，其实是一种数据库规范，用在 SqlLite 数据库中。可以使用 <a target="_blank" rel="noopener" href="https://github.com/consbio/mbtileserver">mbtileserver</a> 或者 <a target="_blank" rel="noopener" href="https://github.com/maptiler/tileserver-gl">tileserver-gl</a> 将mbtiles格式的瓦片发布为服务。Vector and raster maps with GL styles. Server side rendering by MapLibre GL Native. Map tile server for MapLibre GL JS, Android, iOS, Leaflet, OpenLayers, GIS via WMTS, etc. </p>
<ul>
<li><p>（1）元数据<br>该数据库必须包含一个名为metadata的表或视图。该表必须包含两个名为 name、format、bounds、center、minzoom、maxzoom。metadata表的典型 create 语句：</p>
<figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE table</span> metadata (name text, <span class="keyword">value</span> text);</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>（2）Tiles 瓦片<br>数据库必须包含一个表 named tiles，The 表 必须包含三行 one of type integer, named zoom_level, tile_column,tile_row, and one of type blob, named tile_data。</p>
<figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE table</span> tiles (zoom_level <span class="type">integer</span>, tile_column <span class="type">integer</span>, tile_row <span class="type">integer</span>, tile_data <span class="type">blob</span>);</span><br></pre></td></tr></tbody></table></figure>

</li>
</ul>
<p>注意：使用 TMS tiling scheme, 请求单个瓦片的y轴与 URL 中常用的“XYZ”坐标系相反，所以通常称为 11/327/791 的瓦片插入为 zoom_level 11、tile_column 327 和 tile_row 1256，因为 1256=2^11 - 1 - 791。</p>
<ul>
<li>（3）索引<br>数据库可以包含一个索引提高访问性能:<figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">UNIQUE</span> INDEX tile_index <span class="keyword">on</span> tiles (zoom_level, tile_column, tile_row);</span><br></pre></td></tr></tbody></table></figure>

</li>
</ul>
<div class="reference">参考文章:<br>【1】.<a target="_blank" rel="noopener" href="https://www.cnblogs.com/d1012181765/p/15118634.html">MBTiles</a><br>【2】.<a target="_blank" rel="noopener" href="https://developer.aliyun.com/article/1579675">GIS开发：如何开发一个MBTiles Server</a> 首先，查看MBTiles数据库的结构，可以使用查看SQLite数据库的工具进行查看。一般是包含metadata和标示每张切片的缩放级别、行列号，表结构根据场景有些不同，但是，都具有可以根据缩放级别和行列号，直接查出来对应的切片图片。根据地图的请求url规则，查询MBTiles中的对应切片，进行返回，就能实现在地图端访问到地图切片了。<br>【3】.<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_37219845/article/details/130424146">【地图缓存】MBTiles初步了解</a> MBTiles是一个在 SQLite 数据库存储瓦片地图数据的标准。MBTiles 仅支持切片数据，包括矢量、栅格瓦片，它使得数以百万的瓦片数据存储在一个文件中，而且SQLite数据库支持多种平台，MBTiles在移动设备上浏览瓦片数据有一定的优势。<br>【4】.<a target="_blank" rel="noopener" href="https://gitee.com/alvinTao/mbtiles-image-server?skip_mobile=true">mbtile-image-server</a> 基于springboot实现,实现获取本地目录中的.mbtiles文件，发布成切片服务,支持图片格式切片（png\jpg）,支持矢量格式切片（pbf）<br>【5】.<a target="_blank" rel="noopener" href="https://github.com/DenisCarriere/mbtiles-server">mbtiles-server</a> Provides a compatible WMTS Tile Server from MBTiles.<br>【6】.<a target="_blank" rel="noopener" href="https://live.osgeo.org/archive/6.5/zh/quickstart/maptiler_quickstart.html">MapTiler 快速入门文档</a>  MapTiler 提供了一套简单的解决方案，用于对任何具备地理参考的地图图像生成切片。这些切片可以用于网络地图服务。它遵循 Open Source Geospatial Foundation (OSGeo) 的 Tile Map Service (TMS) 标准。<br>【7】.<a target="_blank" rel="noopener" href="https://blog.51cto.com/u_16213415/8856677">python 创建 mbtiles</a> 这里是使用的 python 创建 mbtiles 文件，然后插入了数据，这里有表结构可以参考。<br>【8】.<a target="_blank" rel="noopener" href="https://blog.51cto.com/fish/5777132">【GIS开发】批量地图瓦片转mbtiles文件（Python） 精选</a> 这也是地图瓦片转 mbtiles 文件。<br>【9】.<a target="_blank" rel="noopener" href="https://blog.csdn.net/qiang89/article/details/109779199">MBTiles规范说明 中文版</a><br>【10】.<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_37219845/article/details/130424146">【地图缓存】MBTiles初步了解</a></div>
<h1 id="6-xyz转mbtiles"><a href="#6-xyz转mbtiles" class="headerlink" title="6.xyz转mbtiles"></a>6.xyz转mbtiles</h1><p>使用 xyz 格式，就是通用的格式，还可以转成 mbtiles 格式。<br>（1）已切好的地图瓦片存放在文件系统中，会产生大量的文件碎片，占用空间会比实际容量大很多。<br>（2）利用数据表里的byte来存储图片，使用时通过查询数据表就可以读取图片，优点是大大减少存储量，缺点是大量的查询会拖慢服务器，较适合离线地图使用。 </p>
<div class="reference">参考文章:<br>【1】.<a target="_blank" rel="noopener" href="https://blog.csdn.net/sig321/article/details/144139230">QGIS制作xyz切片（mbtiles）</a>  MBTiles是由MapBox制定的一种将瓦片地图数据存储到SQLite数据库中并可快速使用，管理和分享的规范。它使得数以百万的瓦片数据存储在一个文件中，而且SQLite数据库支持多种平台，所以使用MBTiles在移动设备上浏览瓦片数据是比较理想的方式。<br>【2】.<a target="_blank" rel="noopener" href="https://github.com/mapbox/mbutil">mbutil</a> 这是mapbox写的一个工具，将xyz文件转为mbtiles。MBUtil is a utility for importing and exporting the MBTiles format, typically created with Mapbox TileMill.Before exporting tiles to disk, see if there’s a Mapbox Hosting plan or an open source MBTiles server implementation that works for you - tiles on disk are notoriously difficult to manage.<br>【3】.<a target="_blank" rel="noopener" href="https://github.com/DXnima/WebGISdata">WebGISdata</a> 构建mbtiles格式的矢量瓦片、栅格瓦片、地形瓦片以及使用OSM数据构建瓦片. 在数据处理过程中, 最难的是安装各种环境, 现在整合了一个Docker镜像, 包括 GDAL | tippecanoe | mbutil | osmium | rio-rgbify | dem2terrain | tilemaker 这些环境.<br>【4】.<a target="_blank" rel="noopener" href="https://blog.csdn.net/hhy321/article/details/123320478">批量地图瓦片转mbtiles文件（Python）</a> 这里也是用了 mbutil 这个工具，进行了截图和操作说明，还有调用。<br>【5】.<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_35582643/article/details/140542001">arcgis紧凑型切片缓存(解决大范围切片，文件数量大的问题)</a> 个人认为无论那种压缩或合并格式都会产生效率损失，因为各类普遍应用前端应用读写前都会解压翻译成标准格式，而解压翻译国产就会产生效率损失!所以如小范围还是xyz的切片格式最快。<br>【6】.<a target="_blank" rel="noopener" href="https://blog.csdn.net/ludepsea/article/details/103588254">ArcGIS紧凑型切片读取与应用3-紧凑型批量转分散型(附源码)</a><br>【7】.<a target="_blank" rel="noopener" href="https://blog.csdn.net/u013323965/article/details/53213298">利用MBTiles技术原理减轻离线地图的存储量</a> 这里用了java代码，读取了文件，形成byte，然后可以存储到服务器中。<br>【8】.<a target="_blank" rel="noopener" href="https://blog.csdn.net/sinat_36226553/article/details/121429462">GIS：MBTiles数据</a> 1.MBTiles;2.SQLite中的MBTiles;3.数据生成:QGIS、tippecanoe、MBUtil。4.发布：GeoServer、mbtiles-server（by DenisCarriere）、mbtiles-server（by chelm）、TileServer GL。5.客户端调用：leaflet、openlayers、cesium。6.SMTiles格式数据，由于MBTiles格式数据限制性较多，超图推出了一种MBTiles的扩展格式SMTiles。<br>【9】.<a target="_blank" rel="noopener" href="https://blog.csdn.net/lostsoulaside/article/details/123915943">java中使用MBUtil工具将png转mbtiles</a> mbutil工具除了需要瓦片数据外，还需要一个很重要的文件：metadata.json，该文件中最重要的一个参数就是bounds，在使用该工具前，先去根据你格网的原始层级以及行列号计算出坐标,注意：坐标顺序为左下右上。<br>【10】.<a target="_blank" rel="noopener" href="https://worktile.com/kb/ask/1811034.html">开源地图用什么服务器好</a> 1.MapServer;2.GeoServer;3.TileServer;4.Mapnik;5.OpenLayers;</div>
<h1 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h1><p>这里是我在使用和切片的时候遇到的问题。</p>
<h2 id="1-metadata-generation-failed系统找不到指定文件"><a href="#1-metadata-generation-failed系统找不到指定文件" class="headerlink" title="1.metadata-generation-failed系统找不到指定文件"></a>1.metadata-generation-failed系统找不到指定文件</h2><p>使用pip 安装 gdal2tiles 的时候就会报错，无法安装 gdal2tiles。出现：Requirements should be satisfied by a PEP 517 installer，error: [WinError 2] 系统找不到指定的文件。</p>
<p>【尝试解决】<br>（1）尝试安装，增加参数，结果无效</p>
<figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install gdal2tiles --use-pep517</span><br></pre></td></tr></tbody></table></figure>

<p>（2）我尝试使用了 OSGeo4W setup 安装了 gdal，已经安装成功了，但是不行。</p>
<p>（3）尝试使用 OSGeo4W 执行 gdal 安装。<br>下面是window的操作步骤，我执行了安装，gdal 也安装成功了，但是还是无法使用 gdal2tiles.</p>
<ul>
<li><p>打开 OSGeo4W setup 程序，选择需要安装的 gdal 版本。</p>
</li>
<li><p>配置环境变量，C:\OSGeo4W\bin</p>
</li>
<li><p>执行验证<br>打开命令行，执行验证命令。</p>
<figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gdalinfo --version</span><br></pre></td></tr></tbody></table></figure>

</li>
</ul>
<p>【解决方案】<br>在<a target="_blank" rel="noopener" href="https://github.com/cgohlke/geospatial-wheels/releases">新的地址上</a>下载 gdal 的版本，安装，因为我的python版本是3.9，所以我选择了  GDAL-3.9.2-cp39-cp39-win_amd64.whl 这个版本。</p>
<figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装 GDAL</span></span><br><span class="line">pip install  GDAL-3.9.2-cp39-cp39-win_amd64.whl</span><br><span class="line"><span class="comment"># 安装 gdal2tiles</span></span><br><span class="line">pip install gdal2tiles</span><br><span class="line"></span><br><span class="line"><span class="comment"># 验证</span></span><br><span class="line">python</span><br><span class="line">from osgeo import gdal</span><br></pre></td></tr></tbody></table></figure>

<div class="reference">参考文章:<br>【1】.<a target="_blank" rel="noopener" href="https://github.com/pypa/pip/issues/11566">Propagate –use-pep517 to build-system requirements</a><br>【2】.<a target="_blank" rel="noopener" href="https://blog.csdn.net/sunyuhua_keyboard/article/details/139469375">阿里云安装python依赖报错 Requirements should be satisfied by a PEP 517 installer.</a><br>【3】.<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_24118527/article/details/90579328">FileNotFoundError: [WinError 2] 系统找不到指定的文件</a><br>【4】.<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/34408699/having-trouble-installing-gdal-for-python-on-windows">Having trouble installing GDAL for Python on Windows</a><br>【5】.<a target="_blank" rel="noopener" href="https://blog.csdn.net/GISuuser/article/details/118058281">python调用gdal2tiles实现栅格影像TMS切片</a><br>【6】.<a target="_blank" rel="noopener" href="https://blog.csdn.net/m0_49895273/article/details/138130486">GDAL的wheel最新下载网址</a> 这里给了问题解决方案。</div>
<h2 id="2-Docker无法启动"><a href="#2-Docker无法启动" class="headerlink" title="2.Docker无法启动"></a>2.Docker无法启动</h2><p>windows上安装，还需要安装docker，如果安装了docker，可以直接使用docker。安装的时候倒是没有问题，就是开启Hyper-V，然后安装，但是启动的时候就出现了问题：Docker Desktop - WSL update failed错误。</p>
<p>【尝试解决】<br>（1）我尝试命令行执行，结果一直都为零，只能说网络不好。</p>
<figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wsl --update</span><br></pre></td></tr></tbody></table></figure>

<p>(3) 使用下面的命令更新，结果不行，因为参数不对。</p>
<figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wsl --install --web-download</span><br></pre></td></tr></tbody></table></figure>

<p>【解决方案】<br>增加参数，从网络下载，结果还是很慢。</p>
<figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wsl --update --web-download</span><br></pre></td></tr></tbody></table></figure>

<p>经过一夜之后，后来甚至出现了：”与服务器的连接被重置“，这个问题，我再次重新执行命令的时候，结果显示 “已安装最新版本的适用于 Linux 的 Windows 子系统”，但是还是启动了Docker，不晓得到底哪里问题。</p>
<div class="reference">参考文章:<br>【1】.<a target="_blank" rel="noopener" href="https://blog.csdn.net/joeyoj/article/details/136427362">【Docker】掌握 Docker魔法：Windows 11 平台上的完美容器部署终极指南</a> 1.安装Hyper-V和WSL。2.安装Docker。还有解决无法启动Docker的问题，主要就是 wsl –update 命令。<br>【2】.<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_61988806/article/details/139106498">wsl –update 进度一直为0</a><br>【3】.<a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows/wsl/install-manual">Manual installation steps for older versions of WSL</a></div>
<h2 id="3-DATABASE-LAYOUT-VERSION-MINOR-2-whereas-a-number-gt-3-is-expected"><a href="#3-DATABASE-LAYOUT-VERSION-MINOR-2-whereas-a-number-gt-3-is-expected" class="headerlink" title="3.DATABASE.LAYOUT.VERSION.MINOR = 2 whereas a number >= 3 is expected"></a>3.DATABASE.LAYOUT.VERSION.MINOR = 2 whereas a number &gt;= 3 is expected</h2><p>使用 gdal2tiles 进行切图的时候，结果出现了这个问题：PROJ: proj_create_from_database: C:\Program Files\PostgreSQL\15\share\contrib\postgis-3.4\proj\proj.db contains DATABASE.LAYOUT.VERSION.MINOR = 2 whereas a number &gt;= 3 is expected</p>
<p>该问题源于GDAL和PostGIS插件对不同版本PROJ的依赖。解决方法是在代码中设置环境变量PROJ_LIB，指向Python安装目录下的PROJ库路径，从而避免环境变量的干扰，成功运行代码。 </p>
<p>【解决方案】<br>我因为在 windos 上测试的，于是我就搜索了 proj 的目录，因为我的虚拟环境是 yolo，最后的路径就是如下：</p>
<figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">import os</span><br><span class="line"><span class="comment"># 对应自己的python包的安装地址</span></span><br><span class="line">os.environ[<span class="string">'PROJ_LIB'</span>] = r<span class="string">'C:\Soft\anaconda3\envs\yolo\Lib\site-packages\osgeo\data\proj'</span> </span><br><span class="line"></span><br><span class="line"><span class="comment"># linux</span></span><br><span class="line">os.environ[<span class="string">'PROJ_LIB'</span>] = <span class="string">'/home/hj/.conda/envs/ai/share/proj'</span></span><br></pre></td></tr></tbody></table></figure>

<div class="reference">参考文章:<br>【1】.<a target="_blank" rel="noopener" href="https://blog.csdn.net/GISuuser/article/details/130706490">GDAL与PostGIS使用的PROJ库版本冲突问题解决方案</a> 这里说明了问题。<br>【2】.<a target="_blank" rel="noopener" href="https://blog.csdn.net/quxuexi/article/details/122410009">python 查看pip install安装依赖路径</a> 这里查看以来包的路径。<br>【3】.<a target="_blank" rel="noopener" href="https://blog.csdn.net/shendygis/article/details/114386509">gdal设置proj_lib路径</a> 这里在linux上设置了共享目录。<br>【4】.<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_36871430/article/details/128664236">linux下安装 gdal环境与项目配置</a> 这个没有用。</div>
<h2 id="4-切片空白"><a href="#4-切片空白" class="headerlink" title="4.切片空白"></a>4.切片空白</h2><p>我使用 gdal2tiles 切出来的总是空白的，开始的时候，总是不知道什么原因。</p>
<p>【尝试方案】<br>（1）我尝试了使用 profile 定义投影，结果无效。<br>（2）尝试 s_srs 参数定义投影，结果还是一样。</p>
<p>【解决方案】<br>后来我发现，是因为我的切片的级别太高了，我用无人机拍摄的图片，定义了一个 7-9 级，所以切出来的就是一个空白。</p>
<div class="reference">参考文章:<br>【1】.<a target="_blank" rel="noopener" href="https://blog.csdn.net/wml00000/article/details/130517935">gdal2tiles切图</a><br>【2】.<a target="_blank" rel="noopener" href="https://gdal.org/en/latest/programs/gdal2tiles.html">gdal2tiles</a> 这里是 gdal 自带的切片工具，好像不用装就可以了。</div>
<h2 id="5-the-input-device-is-not-a-TTY-If-you-are-using-mintty-try-prefixing-the-command-with-‘winpty’"><a href="#5-the-input-device-is-not-a-TTY-If-you-are-using-mintty-try-prefixing-the-command-with-‘winpty’" class="headerlink" title="5.the input device is not a TTY.  If you are using mintty, try prefixing the command with ‘winpty’"></a>5.the input device is not a TTY.  If you are using mintty, try prefixing the command with ‘winpty’</h2><p>我在使用 java 的 Runtime 执行命令的时候，出现了这个问题。</p>
<p>【尝试方案】<br>（1）我尝试增加 winpty ，结果不行。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">String cmd=<span class="string">"winpty docker.exe run -it --rm  -v "</span>+photoPath+<span class="string">"/images:/code/images -v "</span>+photoPath+<span class="string">"/odm_orthophoto:/code/odm_orthophoto opendronemap/odm"</span>;</span><br></pre></td></tr></tbody></table></figure>

<p>（2）使用 commons-exec 执行，结果还是不行</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">CommandLine</span> <span class="variable">commandLine</span> <span class="operator">=</span> CommandLine.parse(cmd);</span><br><span class="line"><span class="type">Executor</span> <span class="variable">executor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultExecutor</span>();</span><br><span class="line"><span class="type">ByteArrayOutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line"><span class="type">PumpStreamHandler</span> <span class="variable">streamHandler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PumpStreamHandler</span>(outputStream);</span><br><span class="line">executor.setStreamHandler(streamHandler);</span><br><span class="line">executor.execute(commandLine);</span><br></pre></td></tr></tbody></table></figure>

<p>（3）尝试使用 cmd 命令,结果无效。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">String cmd=<span class="string">"docker run -it --rm  -v "</span>+photoPath+<span class="string">"/images:/code/images -v "</span>+photoPath+<span class="string">"/odm_orthophoto:/code/odm_orthophoto opendronemap/odm"</span>;</span><br><span class="line"><span class="type">Runtime</span> <span class="variable">run</span> <span class="operator">=</span> Runtime.getRuntime();</span><br><span class="line"><span class="comment">// 启动进程</span></span><br><span class="line"><span class="type">Process</span> <span class="variable">process</span> <span class="operator">=</span>run.exec(<span class="keyword">new</span> <span class="title class_">String</span>[]{ <span class="string">"cmd"</span>, <span class="string">"/c"</span>, cmd});</span><br></pre></td></tr></tbody></table></figure>

<p>【解决方案】<br>其实解决方案就是把这个参数进行调整一下，直接把这个 -it 参数去掉就可以了。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">String cmd=<span class="string">"docker run --rm  -v "</span>+photoPath+<span class="string">"/images:/code/images -v "</span>+photoPath+<span class="string">"/odm_orthophoto:/code/odm_orthophoto opendronemap/odm"</span>;</span><br><span class="line"><span class="type">Runtime</span> <span class="variable">run</span> <span class="operator">=</span> Runtime.getRuntime();</span><br><span class="line"><span class="comment">// 启动进程</span></span><br><span class="line"><span class="type">Process</span> <span class="variable">process</span> <span class="operator">=</span>run.exec(<span class="keyword">new</span> <span class="title class_">String</span>[]{ <span class="string">"cmd"</span>, <span class="string">"/c"</span>, cmd});</span><br></pre></td></tr></tbody></table></figure>

<div class="reference">参考文章:<br>【1】.<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/48623005/docker-error-on-windows-the-input-device-is-not-a-tty-if-you-are-using-mintty">docker error on windows : the input device is not a TTY. If you are using mintty, try prefixing the command with ‘winpty’ [duplicate]</a> So just prefix with winpty winpty docker-compose exec workspace bash<br>【2】.<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_43343144/article/details/107455589">【Docker 使用git bash运行错误】the input device is not a TTY. If you are using mintty, try prefixing </a> 再Windows上运行 git bash 来执行docker命令，使用 -it参数时会报此错误，必须使用Windows自动的cmd命令才能分配新的终端！ 切换powershell即可<br>【3】.<a target="_blank" rel="noopener" href="https://blog.51cto.com/u_16175508/7168943">java 直接执行docker 命令</a> 这里就提到了使用 commons-exec 执行命令。<br>【4】.<a target="_blank" rel="noopener" href="https://docs.pingcode.com/baike/3820118">java如何调用docker</a> 1.使用Docker Java客户端库。2.通过命令行调用Docker命令。3.使用容器编排工具。<br>【5】.<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_37271626/article/details/108416078">在win10上安装docker之后使用git bash 或者xshell 操作时的问题 以及解决办法</a><br>【6】.<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_34823218/article/details/107165461">JAVA代码执行CMD命令 RunTime.getRuntime().exec()</a><br>【7】.<a target="_blank" rel="noopener" href="https://blog.csdn.net/zzq060143/article/details/91050203">the input device is not a TTY. If you are using mintty, try prefixing the command with ‘winpty’</a> 还是老老实实以管理员权限打开cmd，然后在运行就可以了，简单吧^^<br>【8】.<a target="_blank" rel="noopener" href="https://blog.csdn.net/sunmingyang1987/article/details/108877902">报错解决：the input device is not a TTY</a> 如果让脚本在后台运行，就没有可交互的终端，这就会引发如题所示错误，解决办法就是去掉“-it”这个参数。</div>
<h2 id="6-java命令执行docker卡住"><a href="#6-java命令执行docker卡住" class="headerlink" title="6.java命令执行docker卡住"></a>6.java命令执行docker卡住</h2><p>(1) 两个线程分别读取 标准输出 和 错误输出。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">runCMD</span><span class="params">(String cmd)</span> {</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">result</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="type">Process</span> <span class="variable">process</span> <span class="operator">=</span> Runtime.getRuntime().exec(cmd);</span><br><span class="line">        <span class="comment">// 读取输出流</span></span><br><span class="line">        <span class="type">Thread</span> <span class="variable">outputThread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; {</span><br><span class="line">            <span class="keyword">try</span> (<span class="type">BufferedReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(process.getInputStream()))) {</span><br><span class="line">                String line;</span><br><span class="line">                <span class="keyword">while</span> ((line = reader.readLine()) != <span class="literal">null</span>) {</span><br><span class="line">                    System.out.println(line);</span><br><span class="line">                }</span><br><span class="line">            } <span class="keyword">catch</span> (IOException e) {</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            }</span><br><span class="line">        });</span><br><span class="line">        outputThread.start();</span><br><span class="line">        <span class="comment">// 读取错误流</span></span><br><span class="line">        <span class="type">Thread</span> <span class="variable">errorThread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; {</span><br><span class="line">            <span class="keyword">try</span> (<span class="type">BufferedReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(process.getErrorStream()))) {</span><br><span class="line">                String line;</span><br><span class="line">                <span class="keyword">while</span> ((line = reader.readLine()) != <span class="literal">null</span>) {</span><br><span class="line">                    System.err.println(line);</span><br><span class="line">                }</span><br><span class="line">            } <span class="keyword">catch</span> (IOException e) {</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            }</span><br><span class="line">        });</span><br><span class="line">        errorThread.start();</span><br><span class="line">        process.waitFor(); <span class="comment">// 等待命令执行完毕</span></span><br><span class="line">        <span class="comment">// 等待线程执行完毕</span></span><br><span class="line">        outputThread.join();</span><br><span class="line">        errorThread.join();</span><br><span class="line">    }<span class="keyword">catch</span> (Exception e) {</span><br><span class="line">        log.error(e.getMessage());</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>(2) 另外一种写法，也是通过多线程清空输出内容</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 执行 cmd命令</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> cmd</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">runCMD</span><span class="params">(String cmd)</span> {</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">result</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="type">StringBuilder</span> <span class="variable">stringBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">    <span class="type">Process</span> <span class="variable">process</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        process = Runtime.getRuntime().exec(cmd);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">InputStream</span> <span class="variable">is1</span> <span class="operator">=</span> process.getInputStream();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">Runnable</span>() {</span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> {</span><br><span class="line">                <span class="type">BufferedReader</span> <span class="variable">bufferedReader</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">                <span class="type">String</span> <span class="variable">line</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">                <span class="keyword">try</span> {</span><br><span class="line">                    bufferedReader = <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(is1, <span class="string">"GBK"</span>));</span><br><span class="line">                    <span class="keyword">while</span>((line=bufferedReader.readLine()) != <span class="literal">null</span>)</span><br><span class="line">                    {</span><br><span class="line"><span class="comment">//                            stringBuilder.append(line+"\n");</span></span><br><span class="line">                        log.info(line);</span><br><span class="line">                    }</span><br><span class="line">                    is1.close();</span><br><span class="line">                } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">                    <span class="comment">// TODO Auto-generated catch block</span></span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }).start(); <span class="comment">// 启动单独的线程来清空p.getInputStream()的缓冲区</span></span><br><span class="line">        result = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">is2</span> <span class="operator">=</span> process.getErrorStream();</span><br><span class="line">        <span class="type">BufferedReader</span> <span class="variable">br2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(is2));</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">buf</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>(); <span class="comment">// 保存输出结果流</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">line2</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">while</span>((line2 = br2.readLine()) != <span class="literal">null</span>)</span><br><span class="line">        {</span><br><span class="line"><span class="comment">//                buf.append(line2);</span></span><br><span class="line">            log.info(line2);</span><br><span class="line">            result = <span class="literal">false</span>;</span><br><span class="line">        }</span><br><span class="line">    } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<div class="reference">参考文章:<br>【1】.<a target="_blank" rel="noopener" href="https://blog.51cto.com/u_16175526/7155686">java 执行cmd命令卡住</a><br>【2】.<a target="_blank" rel="noopener" href="https://www.cnblogs.com/nihaorz/p/12023342.html">java执行命令行，以及解决卡死问题</a> 一般程序的做法是先循环读正确的返回流，再读错误的返回流，当正确的返回流读不完的时候，有可能错误的返回流已经占满了缓存，所以导致了卡死。使用ProcessBuild类，这个类可以把错误流重定向到正确流，这样只读一个流就可以了，不论正确或错误，都能读到返回。<br>【3】.<a target="_blank" rel="noopener" href="https://blog.51cto.com/u_16213321/7076292">Java 执行 系统命令卡住</a> 1.输入/输出流阻塞;2.命令等待输入;3.命令执行时间过长;<br>【4】.<a target="_blank" rel="noopener" href="https://www.cnblogs.com/zhangzhiyong-/p/13364870.html">java执行cmd命令的两种方法</a> 第二种方法是先生成一个缓存文件，用来缓存执行过程中输出的信息，这样在执行命令的时候不会卡<br>【5】.<a target="_blank" rel="noopener" href="https://blog.csdn.net/yaya_jn/article/details/126418888">Java中Process和Runtime()使用，以及调用cmd命令阻塞解决</a> 一直认为是getInputStream的缓冲区没有被清空，不过问题确实是缓冲区的内容没有被清空，但不是getInputStream的，而是getErrorStream的缓冲区，这样问题就得到解决了。所以我们在遇到java调用外部程序而导致线程阻塞的时候，可以考虑使用两个线程来同时清空process获取的两个输入流，如下这段程序<br>【6】.<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/21479974/values-of-process-exitvalue-in-java">Values of process.exitValue() in JAVA</a> That’s up to the process in question. Even the “0 means success” is a convention more than anything else - although it’s a very common one.<br>【7】.<a target="_blank" rel="noopener" href="https://blog.51cto.com/stefanxfy/5083542#2_122">Runtime.getRuntime().exec踩坑总结（/bin/sh -c、异常流重定向）</a> ​​java.lang.Runtime#exec​​返回一个Process类，可用于控制命令执行的进程，比如获取标准输出流、标准输入流及异常流，获取该进程的执行状态，销毁该进程等。</div>
<h2 id="7-java执行命令行权限问题"><a href="#7-java执行命令行权限问题" class="headerlink" title="7.java执行命令行权限问题"></a>7.java执行命令行权限问题</h2><p>在 linux 上执行 runtime 命令，不使用root命令执行的时候，会出现权限的问题。</p>
<p>【解决方案】<br>后来我干脆就直接把用户加入了 docker 组，这样就方便了。</p>
<figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> usermod -aG docker username</span><br></pre></td></tr></tbody></table></figure>

<div class="reference">参考文章:<br>【1】.<a target="_blank" rel="noopener" href="https://blog.csdn.net/10km/article/details/78913746">java:执行linux sudo命令</a><br>【2】.<a target="_blank" rel="noopener" href="https://www.cnblogs.com/wiliamzhao/p/13490676.html">java代码执行Linux的sudo命令</a><br>【3】.<a target="_blank" rel="noopener" href="https://learnku.com/articles/64047">普通用户权限运行docker</a> 这里直接设置了 usermod。</div>
<h2 id="8-Uh-oh-Processing-stopped-because-of-strange-values-in-the-reconstruction-This-is-often-a-sign-that-the-input-data-has-some-issues-or-the-software-cannot-deal-with-it-Have-you-followed-best-practices-for-data-acquisition"><a href="#8-Uh-oh-Processing-stopped-because-of-strange-values-in-the-reconstruction-This-is-often-a-sign-that-the-input-data-has-some-issues-or-the-software-cannot-deal-with-it-Have-you-followed-best-practices-for-data-acquisition" class="headerlink" title="8.Uh oh! Processing stopped because of strange values in the reconstruction. This is often a sign that the input data has some issues or the software cannot deal with it. Have you followed best practices for data acquisition"></a>8.Uh oh! Processing stopped because of strange values in the reconstruction. This is often a sign that the input data has some issues or the software cannot deal with it. Have you followed best practices for data acquisition</h2><p>在windows上调试，没有问题，但是放到到服务器上，就出现了问题。</p>
<p>【解决方案】<br>其实我也没有解决，就是重新换了一台服务器运行，看看行不行。</p></body></html>
              </div>
            </div>
          </div>
          <div class='post-footer'>
            <div>**本文已结束，感谢您的观看**</div>
            <div class="btn btn-pay">鼓励一下</div>
          </div>
          
            <div class="page">
              
              <section class="past-wrap">
                <section class="past">
                <p>往期推荐</p>
                </section>
              </section>
              <div class="post-nav">
                <div class="post-nav-next post-nav-item">
                  
                    <a href="/posts/54fc60c1.html" rel="next" title="技术研究之腾讯云直播">
                      <i class="iconfont icon-prev"></i> 技术研究之腾讯云直播
                    </a>
                  
                </div>

                <span class="post-nav-divider"></span>

                <div class="post-nav-prev post-nav-item">
                  
                    <a href="/posts/b31999f5.html" rel="prev" title="技术研究之断点续传">
                      技术研究之断点续传 <i class="iconfont icon-next"></i>
                    </a>
                  
                </div>
              </div>
            </div>
          
          
 <div class="comments" id="comments">
    <div id="disqus_thread">
        <noscript>
            不支持Javascript,那你还上啥网啊。
            <a target="_blank" rel="noopener" href="https://disqus.com/?ref_noscript"></a>
        </noscript>
    </div>
</div>

      </div>
    </div>


    <div class="layui-col-md2 layui-col-lg2 layui-col-sm10 layui-col-xs12 catalogue-wrap">
        

<div class="catalogue-content">
    <div class="title">文章目录</div>
    <div class="toc-content">
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">1.前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-%E6%97%A0%E4%BA%BA%E6%9C%BA"><span class="toc-number">2.</span> <span class="toc-text">2.无人机</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-OpenDroneMap"><span class="toc-number">3.</span> <span class="toc-text">2.OpenDroneMap</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-%E5%AE%89%E8%A3%85"><span class="toc-number">3.1.</span> <span class="toc-text">2.1.安装</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-%E4%BD%BF%E7%94%A8"><span class="toc-number">3.2.</span> <span class="toc-text">2.2.使用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-4-docker-java"><span class="toc-number">3.3.</span> <span class="toc-text">2.4.docker-java</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-5-java%E5%91%BD%E4%BB%A4%E8%A1%8C"><span class="toc-number">3.4.</span> <span class="toc-text">2.5.java命令行</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-6-python%E5%91%BD%E4%BB%A4%E8%A1%8C"><span class="toc-number">3.5.</span> <span class="toc-text">2.6.python命令行</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-7-GPU"><span class="toc-number">3.6.</span> <span class="toc-text">2.7.GPU</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-%E5%88%87%E7%89%87"><span class="toc-number">4.</span> <span class="toc-text">3.切片</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-%E5%AE%89%E8%A3%85gdal"><span class="toc-number">4.1.</span> <span class="toc-text">3.1.安装gdal</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-%E5%AE%89%E8%A3%85-gdal2tiles"><span class="toc-number">4.2.</span> <span class="toc-text">3.2.安装 gdal2tiles</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-%E5%88%87%E7%89%87"><span class="toc-number">4.3.</span> <span class="toc-text">3.3.切片</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-4-%E8%BF%9B%E9%98%B6"><span class="toc-number">4.4.</span> <span class="toc-text">3.4.进阶</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-%E5%8F%91%E5%B8%83"><span class="toc-number">5.</span> <span class="toc-text">4.发布</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-%E5%89%8D%E7%AB%AF%E5%8A%A0%E8%BD%BD"><span class="toc-number">6.</span> <span class="toc-text">5.前端加载</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-MbTiles"><span class="toc-number">7.</span> <span class="toc-text">5.MbTiles</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#6-xyz%E8%BD%ACmbtiles"><span class="toc-number">8.</span> <span class="toc-text">6.xyz转mbtiles</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%97%AE%E9%A2%98"><span class="toc-number">9.</span> <span class="toc-text">问题</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-metadata-generation-failed%E7%B3%BB%E7%BB%9F%E6%89%BE%E4%B8%8D%E5%88%B0%E6%8C%87%E5%AE%9A%E6%96%87%E4%BB%B6"><span class="toc-number">9.1.</span> <span class="toc-text">1.metadata-generation-failed系统找不到指定文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-Docker%E6%97%A0%E6%B3%95%E5%90%AF%E5%8A%A8"><span class="toc-number">9.2.</span> <span class="toc-text">2.Docker无法启动</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-DATABASE-LAYOUT-VERSION-MINOR-2-whereas-a-number-gt-3-is-expected"><span class="toc-number">9.3.</span> <span class="toc-text">3.DATABASE.LAYOUT.VERSION.MINOR &#x3D; 2 whereas a number &gt;&#x3D; 3 is expected</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E5%88%87%E7%89%87%E7%A9%BA%E7%99%BD"><span class="toc-number">9.4.</span> <span class="toc-text">4.切片空白</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-the-input-device-is-not-a-TTY-If-you-are-using-mintty-try-prefixing-the-command-with-%E2%80%98winpty%E2%80%99"><span class="toc-number">9.5.</span> <span class="toc-text">5.the input device is not a TTY.  If you are using mintty, try prefixing the command with ‘winpty’</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-java%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8Cdocker%E5%8D%A1%E4%BD%8F"><span class="toc-number">9.6.</span> <span class="toc-text">6.java命令执行docker卡住</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-java%E6%89%A7%E8%A1%8C%E5%91%BD%E4%BB%A4%E8%A1%8C%E6%9D%83%E9%99%90%E9%97%AE%E9%A2%98"><span class="toc-number">9.7.</span> <span class="toc-text">7.java执行命令行权限问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-Uh-oh-Processing-stopped-because-of-strange-values-in-the-reconstruction-This-is-often-a-sign-that-the-input-data-has-some-issues-or-the-software-cannot-deal-with-it-Have-you-followed-best-practices-for-data-acquisition"><span class="toc-number">9.8.</span> <span class="toc-text">8.Uh oh! Processing stopped because of strange values in the reconstruction. This is often a sign that the input data has some issues or the software cannot deal with it. Have you followed best practices for data acquisition</span></a></li></ol></li></ol>
    </div>
</div>


        <div class="sidecontent">

    

    <div class="side-panel side-sponsor">
        <div class="side-title one">小额赞助</div>
        <div class="side-content-wrap">
            <div class="side-content">
                <div class="heading">本人提供免费与付费咨询服务，感谢您的支持！赞助请发邮件通知，方便公布您的善意！</div>
                <div class="content">
                    <img src="/images/pay.png" title="小额赞助"/>
                </div>
                
                
                <div class="donor_content">
                    
                        
                        <div class="donor-item">
                            <span class="name">**光</span>
                            <span class="money">3.01 元</span>
                        </div>
                    
                        
                        <div class="donor-item">
                            <span class="name">Sun</span>
                            <span class="money">3.00 元</span>
                        </div>
                    
                        
                        <div class="donor-item">
                            <span class="name">bibichuan</span>
                            <span class="money">3.00 元</span>
                        </div>
                    
                    <div class="donor_footer">
                        <span>捐赠者名单</span>
                        <span class="total">合计：9.01 元</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="side-ad side-panel">
        <div class="side-title two">微信公众号</div>
        <div class="side-content-wrap">
            <div class="side-content">
                <img src="/images/wechat.png" title="公众号"/>
            </div>
        </div>
    </div>

    <div class="side-ad side-panel">
        <div class="side-title one">广告位</div>
        <div class="side-content-wrap">
            <div class="side-content">
                <div class="heading">诚心邀请广大金主爸爸洽谈合作</div>
                <div class="detail">
                </div>
            </div>
        </div>
    </div>

    <div class="side-ask side-panel">
        
        <div class="side-title two">每日一省</div>
        <div class="side-content-wrap">
            <div class="side-content">
                <div class="heading">isNaN 和 Number.isNaN 函数的区别？</div>
                <div class="detail">
                    
                        <p>1.函数 isNaN 接收参数后，会尝试将这个参数转换为数值，任何不能被转换为数值的的值都会返回 true，因此非数字值传入也会返回 true ，会影响 NaN 的判断。</p>
                    
                        <p>2.函数 Number.isNaN 会首先判断传入参数是否为数字，如果是数字再继续判断是否为 NaN ，不会进行数据类型的转换，这种方法对于 NaN 的判断更为准确。</p>
                    
                </div>
            </div>
            <div class="side-footer">
                <span class="side-footer-item time">2021-04-07</span>
                
                    <span class="side-footer-item side-button down" title="查看答案">
                        <i class="iconfont icon-expansion"></i>
                    </span>
                
                
                    <a class="side-footer-item side-button answer-url" href="https://juejin.cn/post/6940945178899251230"
                    target="_blank">链接地址</a>
                
            </div>
        </div>
    </div>
    <div class="side-ask side-panel">
        
        <div class="side-title three">每日二省</div>
        <div class="side-content-wrap">
            <div class="side-content">
                <div class="heading">为什么0.1+0.2 ! == 0.3，如何让其相等?</div>
                <div class="detail">
                     
                        <p>一个直接的解决方法就是设置一个误差范围，通常称为“机器精度”。对JavaScript来说，这个值通常为2-52，在ES6中，提供了Number.EPSILON属性，而它的值就是2-52，只要判断0.1+0.2-0.3是否小于Number.EPSILON，如果小于，就可以判断为0.1+0.2 ===0.3。</p>
                    
                </div>
            </div>
            <div class="side-footer">
                <span class="side-footer-item time">2021-04-07</span>
                
                    <span class="side-footer-item side-button down" title="查看答案">
                        <i class="iconfont icon-expansion"></i>
                    </span>
                
                
                    <a class="side-footer-item side-button answer-url" href="https://juejin.cn/post/6940945178899251230#heading-8"
                    target="_blank">链接地址</a>
                
            </div>
        </div>
    </div>
    <div class="side-ask side-panel">
        
        <div class="side-title three">每日三省</div>
        <div class="side-content-wrap">
            <div class="side-content">
                <div class="heading">== 操作符的强制类型转换规则？</div>
                <div class="detail">
                     
                        <p>1.首先会判断两者类型是否**相同，**相同的话就比较两者的大小。</p>
                    
                        <p>2.类型不相同的话，就会进行类型转换。</p>
                    
                        <p>3.会先判断是否在对比 null 和 undefined，是的话就会返回 true。</p>
                    
                        <p>4.判断两者类型是否为 string 和 number，是的话就会将字符串转换为 number。</p>
                    
                        <p>5.判断其中一方是否为 boolean，是的话就会把 boolean 转为 number 再进行判断。</p>
                    
                        <p>6.判断其中一方是否为 object 且另一方为 string、number 或者 symbol，是的话就会把 object 转为原始类型再进行判断。</p>
                    
                </div>
            </div>
            <div class="side-footer">
                <span class="side-footer-item time">2021-04-07</span>
                
                    <span class="side-footer-item side-button down" title="查看答案">
                        <i class="iconfont icon-expansion"></i>
                    </span>
                
                
                    <a class="side-footer-item side-button answer-url" href="https://juejin.cn/post/6940945178899251230#heading-12"
                    target="_blank">链接地址</a>
                
            </div>
        </div>
    </div>
    <div class="side-ask side-panel">
        
        <div class="side-title two">每日英语</div>
        <div class="side-content-wrap">
            <div class="side-content">
                <div class="heading">Happiness is time precipitation, smile is the lonely sad.</div>
                <div class="detail">幸福是年华的沉淀，微笑是寂寞的悲伤。</div>
            </div>
            <div class="side-footer">
                <span class="side-footer-item time">2016</span>
                
                    <span class="side-footer-item side-button down" title="查看翻译">
                        <i class="iconfont icon-expansion"></i>
                    </span>
                
                <span class="side-footer-item author">——— 美文</span>
            </div>
        </div>
    </div>

</div>
    </div>

  </div>
  <div class="side-tool">
    <div class="side-icon-wrap">
        <i class="iconfont icon-sidemenu"></i>
    </div>
    <ul class="side-tool-content">
        <li title="回到顶部" class="back-to-top side-tool-item">
            <a class="function-button"><i class="iconfont icon-backtop"></i></a>
        </li> 
        <li title="分享文章" class="side-share side-tool-item">
            <a class="function-button"><i class="iconfont icon-share"></i></a>
            <div class="iShare iShare-content"></div>
        </li>
        <li title="喜欢文章" class="side-like side-tool-item">
            <a class="function-button"><i class="iconfont icon-like"></i></a>
        </li>
         <li class="side-close" title="关闭侧边栏">
            <a class="function-button"><i class="iconfont icon-close"></i></a>
        </li>
    </ul>
</div>

      </div>
    </main>   
    
    <footer id="footer" class="footer layui-fluid">
      <div class="layui-row">
        <div class="container footer-inner">
          <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<div class="footer-col">
  <div>温馨提示</div>
  <div><a href="/about" target="_self">关于作者</a></div>
  <div><a href="/archives">博客归档</a></div>
  <div>
    <span id="busuanzi_container_site_uv">
      访客数<span id="busuanzi_value_site_uv"></span>人次
    </span>
  </div>
</div>
<div class="footer-col">
  <div>友情链接</div>
  
  
  
  
    
        <div><a href="https://malagis.com" target="_blank">麻辣GIS</a></div>
    
  
    
        <div><a href="https://www.giserdqy.com" target="_blank">GIS开发者</a></div>
    
  
    
        <div><a href="https://earth.nullschool.net/zh-cn/" target="_blank">earth.nullschool</a></div>
    
  
    
        <div><a href="https://www.gisclouder.com/" target="_blank">码上GIS实现的热力图</a></div>
    
  
    
        <div><a href="http://www.cnblogs.com/naaoveGIS/" target="_blank">李晓辉的博客园</a></div>
    
  
    
        
          <div><a href="/links">更多</a></div>
          
        
    
  
    
        
    
  
    
        
    
  
    
        
    
  
  <div class="chain-msg">**注意：以上网站都没给钱**</div>
</div>
<div class="footer-col">
  <div>精彩推荐</div>
  
    <div><a href="/study">励志</a></div>
  
    <div><a href="/anime">动漫</a></div>
  
    <div><a href="/movie">电影</a></div>
  
    <div><a href="/tv">电视</a></div>
  
    <div><a href="/book">书籍</a></div>
  
</div>
<div class="footer-col">
  <div>开源项目</div>
  
    <div><a href="/"></a></div>
  
</div>
          
        </div>
      </div>
    </footer>

    


<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>

    
        
            
            
            <script type="text/javascript" src="/lib/layui/layui.js"></script>
        
    
        
    

    
        
            
            
                
            
            <script type="text/javascript" src="https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js"></script>
        
    

    
        
            
            
            <script type="text/javascript" src="/lib/jquery.actual.min.js"></script>
        
    


    


  <script type="text/javascript" src="/js/src/utils.js?v="></script>



    
      <script type="text/javascript" src="https://cdn.jsdelivr.net/algoliasearch/3/algoliasearchLite.min.js"></script>
<script type="text/javascript">
  var client = algoliasearch('DM9LMZOGZE', '1c2739694b8acb4c4edab8ccb098d166');
  var index = client.initIndex('bibichuan');
  $(document).ready(function(){
    var $search=$(".header-wrap");
    var $searchbtn= $search.find(".find");
    var $ipt=$search.find(".search-ipt");
    var $resultClear=$search.find(".clear");
    var $result=$search.find(".result");
    // 加入layui
    layui.use('layer', function(){
      var layer = layui.layer;
      // 搜索按钮点击
      $searchbtn.on("click",function(){
        var text=$ipt.val();
        var $this=$(this);
        var $resultContent=$result.find(".result-content");
        if(text){
          var loadDialog=layer.load();
          if(!$this.hasClass("disabled")){
            $this.addClass("disabled");
            index.search(text, (err, { hits } = {}) => {
              layer.close(loadDialog); 

              $this.removeClass("disabled");
              var resultHtml="";
              // 命中
              if(hits.length>0){
                var count=hits.length;
                for(var i=0;i<count;i++){
                  var h=hits[i];
                  //根据返回值中_highlightResult来判断显示的内容。
                  var content=h.contentStripTruncate;
                  var _highlight=h._highlightResult;

                  var resultC="";
                  var hitType=""; // 命中的类型
                  //标题命中
                  if(_highlight.title&&!resultC){  
                    if(_highlight.title.matchLevel&&_highlight.title.matchLevel!='none'){
                      resultC=_highlight.title.value;
                      hitType="title";
                    }
                  }
                  //分类命中
                  if(_highlight.categories&&!resultC){ 
                    var arr=_highlight.categories;
                    if(arr instanceof Array){
                      var countTemp=arr.length;
                      for(var j=0;j<countTemp;j++){
                        var temp=arr[j];
                        if(temp.matchLevel&&temp.matchLevel!='none'){
                          resultC=temp.value;
                          hitType="categories";
                        }
                      }
                    }else{
                      if(arr.matchLevel&&arr.matchLevel!='none'){
                        resultC=arr.value;
                        hitType="categories";
                      }
                    }
                  }

                  //标签命中
                  if(_highlight.tags&&!resultC){ 
                    var arr=_highlight.tags;
                    if(arr instanceof Array){
                      var countTemp=arr.length;
                      for(var j=0;j<countTemp;j++){
                        var temp=arr[j];
                        if(temp.matchLevel&&temp.matchLevel!='none'){
                          resultC=temp.value;
                          hitType="tags";
                        }
                      }
                    }else{
                      if(arr.matchLevel&&arr.matchLevel!='none'){
                        resultC=arr.value;
                        hitType="tags";
                      }
                    }
                  }

                  // 内容命中
                  if(!resultC){ 
                    resultC=_highlight.contentStripTruncate.value;
                    hitType="contentStripTruncate";
                  }

                  //如果内容过长，则截断
                  if(resultC.length>50){
                    var index=resultC.indexOf('<em>');
                    var blockIndex=10;
                    if(index>=blockIndex){
                      index=index-blockIndex;
                    }else{
                      index=0;
                    }
                    resultC="..."+resultC.substring(index,index+20+blockIndex)+"...";
                  }
                  switch(hitType){
                    case "title":
                      resultC="标题："+resultC;
                      break;
                    case "categories":
                      resultC="分类："+resultC;
                      resultC+=" ("+h.contentStripTruncate.substring(0,40)+"...)";
                      break;
                    case "tags":
                      resultC="标签："+resultC;
                      resultC+=" ("+h.contentStripTruncate.substring(0,40)+"...)";
                      break;
                    case "contentStripTruncate":
                      resultC="内容："+resultC;
                      break;
                  }

                  resultHtml+='<li class="result-item" title="'+content+'"><a href="'+h.permalink+'">'+resultC+'</a></li>';
                }
                $(resultHtml).appendTo($resultContent.empty());
                $result.show();
                $resultClear.show();
              }else{
                var resultHtml='<li class="result-item" title="未找到相关内容"><a>未找到相关内容</a></li>';
                $(resultHtml).appendTo($resultContent.empty());
                $result.show();
                $resultClear.show();
              }
            });
          }
        }else{
          layer.msg("请输入搜索内容");
        }
      });
      // 删除输入内容
      $resultClear.on("click",function(){
        $result.hide();
        $resultClear.hide();
        //清空输入内容
        $ipt.val("");
      });
      // 监听确定事件
      $ipt.keydown(function(e){
        if(e.keyCode==13){
          $searchbtn.click();
        }
      });
    });              
  
  });
</script>
    

    
<script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.6/dist/jquery.fancybox.min.js"></script>
<script src="/js/src/post/post.js">></script>

  

  <script type="text/javascript">
    var disqus_config = function () {
      this.page.url = 'https://bibichuan.github.io/posts/acbb1cd4.html';
      this.page.identifier = 'posts/acbb1cd4.html';
      this.page.title = '技术研究之正射影像';
      };
    // 加载评论内容
    function loadComments () {
      var d = document, s = d.createElement('script');
      s.src = 'https://https-bibichuan-github-io.disqus.com/embed.js';
      s.setAttribute('data-timestamp', '' + +new Date());
      (d.head || d.body).appendChild(s);

      // 隐藏相关文章
      s.onload = function () {
        var relatedCommon=$('#comments #disqus_recommendations');
        if(relatedCommon){
          relatedCommon.hide();
        }

      }
    }
    function scrollFunction(){
      // offsetTop may changes because of manually resizing browser window or lazy loading images.
          var offsetTop = $('#comments').offset().top - $(window).height();
          var scrollTop = $(window).scrollTop();

          // pre-load comments a bit? (margin or anything else)
          if (offsetTop - scrollTop < 60) {
            $(window).off('scroll',scrollFunction);
            loadComments();
          }
    }
    $(function () {
      if($("#comments").length<=0){
        return;
      }
      var offsetTop = $('#comments').offset().top - $(window).height();
      if (offsetTop <= 0) {
        // load directly when there's no a scrollbar
        loadComments();
      } else {
        $(window).on('scroll', scrollFunction);
      }
    });
  </script>



<script src="/lib/share/iShare.js"></script>
<script type="text/javascript">
var iSharel=(new iShare({container:'.iShare-content',config:{
		title: '这里有精彩的内容，你确定不过来看看吗？链接标题：技术研究之正射影像 链接地址:https://bibichuan.github.io/posts/acbb1cd4.html  |(复制此地址在浏览器中打开)——bibichaun出品。',
		description: '技术研究之正射影像',
		url: 'https://bibichuan.github.io/posts/acbb1cd4.html',
		isAbroad: false,
		isTitle: true,
		initialized: true,
		WXoptions:{
			evenType: 'click',
			isTitleVisibility: true,
			title: '技术研究之正射影像',
			isTipVisibility: true,
			tip: '技术研究之正射影像',
			qrcodeW: '120',
			qrcodeH: '120',
			qrcodeFgc: '#4a148c',
      bgcolor: '#2BAD13'
		}
	}}));
</script>


</body>
</html>